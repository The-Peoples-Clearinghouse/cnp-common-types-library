name: Publish to Artifact Registry

on:
    push:
        tags:
            - '*'

jobs:
  publish:
    name: Publish NPM Package
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate New Tag
      id: get_new_tag
      run: |
        git fetch --tags
        LATEST_TAG=$(git tag --sort=-creatordate | head -n 1)
        echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_OUTPUT

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_JSON_AUTH }}

    - name: Configure NPM for Artifact Registry
      run: |
        TOKEN=$(gcloud auth print-access-token)
        echo "//us-central1-npm.pkg.dev/pch-main/pch-npm-private/:_authToken=${TOKEN}" > ~/.npmrc
        echo "@pch-private:registry=https://us-central1-npm.pkg.dev/pch-main/pch-npm-private/" >> ~/.npmrc
        echo "registry=https://registry.npmjs.org/" >> ~/.npmrc

    - name: Install dependencies
      run: npm install

    - name: Bump package version
      run: npm version patch --no-git-tag-version

    - name: Publish to Artifact Registry
      run: |
        npm publish --registry=https://us-central1-npm.pkg.dev/pch-main/pch-npm-private/ --access=public

